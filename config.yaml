# DrishtiChokepointAgent Configuration
# =====================================
# This file controls the behavior of the chokepoint reasoning agent.
# All values can be overridden via environment variables (DRISHTI_* prefix).

# ─────────────────────────────────────────────────────────────────────────────
# Agent Identity
# ─────────────────────────────────────────────────────────────────────────────
agent:
  # Unique name for this agent instance
  name: "drishti-chokepoint-agent"
  
  # Semantic version of the agent protocol
  version: "v0.1.0"

# ─────────────────────────────────────────────────────────────────────────────
# Stream Connection (DrishtiStream)
# ─────────────────────────────────────────────────────────────────────────────
stream:
  # WebSocket URL of the upstream DrishtiStream service
  url: "ws://localhost:8000/ws/stream"
  
  # Delay between reconnection attempts (seconds)
  reconnect_delay_seconds: 5
  
  # Backoff in milliseconds between reconnect attempts
  reconnect_backoff_ms: 500
  
  # Maximum size of internal frame buffer (drops oldest on overflow)
  max_queue_size: 50
  
  # Maximum reconnection attempts before giving up (0 = unlimited)
  max_reconnect_attempts: 0

# ─────────────────────────────────────────────────────────────────────────────
# Perception Configuration
# ─────────────────────────────────────────────────────────────────────────────
perception:
  # Backend for occupancy/density estimation
  # Options: "mock" (testing), "vision" (Google Cloud Vision API)
  backend: "vision"
  
  # Region of interest area in square meters (for density calculation)
  roi_area: 42.0
  
  # EMA smoothing factor for density slope computation
  # Lower values = smoother, slower response; higher = more responsive
  density_smoothing_alpha: 0.2
  
  # Mock backend configuration
  mock:
    # Base people count for mock engine
    fixed_count: 15
    
    # Fixed density to return (people per square meter)
    fixed_density: 0.35
  
  # Vision backend configuration (Google Cloud Vision API)
  vision:
    # Process every N frames (1 = all, 5 = 1 in 5 frames)
    # Higher = lower cost, less responsive
    sample_rate: 5
    
    # Maximum API calls per second
    max_rps: 2.0
    
    # Minimum confidence for person detection (0.0-1.0)
    confidence_threshold: 0.6
    
    # Path to service account JSON (null = use ADC / default credentials)
    credentials_path: "drishti-vision-sa..json"

# ─────────────────────────────────────────────────────────────────────────────
# Motion Configuration (Phase 3)
# ─────────────────────────────────────────────────────────────────────────────
motion:
  # Optical flow method: 'farneback' or 'tvl1'
  optical_flow_method: "farneback"
  
  # Minimum flow magnitude for coherence computation (pixels/frame)
  magnitude_threshold: 0.5
  
  # EMA smoothing factor for coherence (0, 1]
  coherence_smoothing_alpha: 0.3
  
  # Minimum mean magnitude for active scene detection
  min_active_flow_threshold: 0.3
  
  # Chokepoint width in meters
  chokepoint_width: 3.0
  
  # Capacity factor k (persons/meter/second)
  capacity_factor: 1.3

# ─────────────────────────────────────────────────────────────────────────────
# Geometry Configuration
# ─────────────────────────────────────────────────────────────────────────────
geometry:
  # Path to JSON file defining chokepoints, walkable areas, reference lines
  definition_path: "./data/geometry/example_stadium_exit.json"

# ─────────────────────────────────────────────────────────────────────────────
# Decision Thresholds
# ─────────────────────────────────────────────────────────────────────────────
# These thresholds control state transitions. All values are derived from
# crowd dynamics literature (Fruin, Helbing, etc.)

thresholds:
  # Density thresholds (people per square meter)
  # Reference: Level of Service standards (Fruin, 1971)
  density:
    buildup: 0.5     # Transition to BUILDUP state
    recovery: 0.4    # Recovery threshold (lower than buildup)
    critical: 0.7    # Transition to CRITICAL state
  
  # Density slope thresholds (rate of change)
  density_slope:
    buildup: 0.05    # Rapid rise indicates buildup
  
  # Flow pressure thresholds (inflow_rate / capacity ratio)
  # Values > 1.0 indicate inflow exceeds sustainable capacity
  flow_pressure:
    buildup: 0.9
    critical: 1.1
    recovery: 0.7    # Recovery threshold
  
  # Flow coherence thresholds
  # 1.0 = perfectly aligned flow, 0.0 = chaotic
  flow_coherence:
    critical: 0.7    # High coherence amplifies critical conditions

# ─────────────────────────────────────────────────────────────────────────────
# Agent Timing (Phase 4)
# ─────────────────────────────────────────────────────────────────────────────
# Time-based hysteresis to prevent oscillation

timing:
  # Minimum time in state before transitioning (seconds)
  min_state_dwell_sec: 5.0
  
  # Time condition must persist for escalation (seconds)
  escalation_sustain_sec: 3.0
  
  # Time condition must persist for recovery (seconds)
  recovery_sustain_sec: 6.0

# ─────────────────────────────────────────────────────────────────────────────
# Physics Constants
# ─────────────────────────────────────────────────────────────────────────────
# Constants used in crowd dynamics calculations.
# These are empirically derived and should not be changed without justification.

physics:
  # Capacity coefficient (k) for chokepoint flow
  # capacity = k × chokepoint_width
  # Reference: typical pedestrian flow rate ~1.3 persons/meter/second
  capacity_coefficient_k: 1.3
  
  # Minimum flow magnitude to consider as "movement"
  # Filters out noise from optical flow
  min_flow_magnitude: 0.5
  
  # Angular bins for flow direction histogram
  # Used for computing directional entropy
  direction_bins: 8

# ─────────────────────────────────────────────────────────────────────────────
# Server Configuration
# ─────────────────────────────────────────────────────────────────────────────
server:
  # Host to bind to (0.0.0.0 for container deployments)
  host: "0.0.0.0"
  
  # Port to listen on
  port: 8001

# ─────────────────────────────────────────────────────────────────────────────
# Logging Configuration
# ─────────────────────────────────────────────────────────────────────────────
logging:
  # Log level: DEBUG, INFO, WARNING, ERROR, CRITICAL
  level: "INFO"
  
  # Log format: "json" (structured) or "text" (human-readable)
  format: "json"

# ─────────────────────────────────────────────────────────────────────────────
# Observability Configuration (Phase 5)
# ─────────────────────────────────────────────────────────────────────────────
# Controls visualization artifacts - PURELY DESCRIPTIVE, no decision impact

observability:
  # Enable visualization artifacts (walkable mask, heatmap, flow vectors)
  # When disabled: zero performance cost
  enable_viz: true
  
  # Density heatmap resolution (NxN grid)
  heatmap_resolution: 32
  
  # Spacing between flow vectors in pixels
  flow_vector_spacing: 16
